{% block body %}
    <hr>
    <h3>{{ "page.post.show.comments.title"|trans }}</h3>
    {% if is_granted("IS_AUTHENTICATED_FULLY") %}
        {{ form_start(form, {attr: {id: "commentForm"}}) }}
        <div class="form-group">
            {{ form_widget(form.content, {'attr': {'placeholder': "page.post.show.comments.commentph"|trans}}) }}
            {{ form_errors(form.content) }}
        </div>

        {{ form_end(form) }}
    {% else %}
        <div class="alert alert-info">
            {{ "page.post.show.comments.nologin"|trans({'%url%': path('fos_user_security_login')})|raw }}
        </div>
    {% endif %}
    <div id="post-comments">
        To see comments, you need to activate Javascipt
    </div>
{% endblock %}

{% block javascripts %}

    <script>
        $(document).ready(function() {
            $('#commentForm').submit(function(e) {
                e.preventDefault();
                var formURL = "{{ path('post_comment', {"id": post.id}) }}";

                $.post({
                    url: formURL,
                    data: $(this).serialize(),
                    mimeType:"multipart/form-data",
                    success: function (data) {
                        console.log(data);
                        $('#commentForm').find('textarea').val('');
                        showComments();
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error(jqXHR);
                        console.error(textStatus);
                        console.error(errorThrown);
                    }
                });
                return false;
            });

            function showComments() {
                var url = "{{ path('post_get_comment', {"id": post.id}) }}";
                $.get({
                    url: url,
                    success: function(data) {
                        $('#post-comments').html("");

                        data.forEach(function(element) {
                            addComment(element);
                        });
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error(jqXHR);
                        console.error(textStatus);
                        console.error(errorThrown);
                    }
                });
            }

            function addComment(comment) {
                content =
                    "<div class='comment'>" +
                        "<div class='comment-author'>" +
                            "<img src='/{{ profile_picture_directory }}"+ comment.author.profilePicture +"'>" +
                        "</div>" +
                        "<div class='comment-content'>" +
                            "<div class='username'>" +
                                "<a href='"+ comment.author.profileUrl +"'>" + comment.author.username + "</a>" +
                            "</div>" +
                            comment.comment.content +
                        "</div>" +
                    "</div>";
                $('#post-comments').append(content);
            }

            showComments();

        });
    </script>

{% endblock %}